package pl.edu.pw.ii.bpmConsole.rest.tests.integration;

import org.apache.commons.io.IOUtils;

import javax.ws.rs.client.ClientRequestContext;
import javax.ws.rs.client.ClientResponseContext;
import javax.ws.rs.client.ClientResponseFilter;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.StringWriter;
import java.io.Writer;

public class JsonVulnerabilityPrefixStripperFilter implements ClientResponseFilter {

    public static final String JSON_VULNERABILITY_PREFIX = ")]}',\n";

    @Override
    public void filter(ClientRequestContext requestContext, ClientResponseContext responseContext) throws IOException {
        if(responseContext.hasEntity()){
            Writer writer = new StringWriter();
            IOUtils.copy(responseContext.getEntityStream(), writer);
            String responseText = writer.toString();
            if(responseText.startsWith(JSON_VULNERABILITY_PREFIX))
                responseContext.setEntityStream(new ByteArrayInputStream(responseText.substring(6).getBytes("utf-8")));
        }
    }
}
