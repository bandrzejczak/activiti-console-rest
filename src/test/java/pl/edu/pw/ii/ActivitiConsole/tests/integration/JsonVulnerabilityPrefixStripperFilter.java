package pl.edu.pw.ii.ActivitiConsole.tests.integration;

import com.sun.jersey.api.client.ClientHandlerException;
import com.sun.jersey.api.client.ClientRequest;
import com.sun.jersey.api.client.ClientResponse;
import com.sun.jersey.api.client.filter.ClientFilter;

import java.io.ByteArrayInputStream;
import java.io.UnsupportedEncodingException;

public class JsonVulnerabilityPrefixStripperFilter extends ClientFilter {

    public static final String JSON_VULNERABILITY_PREFIX = ")]}',\n";

    @Override
    public ClientResponse handle(ClientRequest request) throws ClientHandlerException {
        ClientResponse response = getNext().handle(request);
        stripPrefixIfExists(response);
        return response;
    }

    private void stripPrefixIfExists(ClientResponse response) {
        String responseText = response.getEntity(String.class);
        if(responseText.startsWith(JSON_VULNERABILITY_PREFIX))
            stripPrefix(response, responseText);
    }

    private void stripPrefix(ClientResponse response, String responseText) {
        try {
            response.setEntityInputStream(new ByteArrayInputStream(responseText.substring(6).getBytes("utf-8")));
        } catch (UnsupportedEncodingException e) {
            throw new ClientHandlerException("Can't strip prefix becouse utf-8 encoding is unsupported!", e);
        }
    }
}
